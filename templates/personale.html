{% extends "navbar.html" %}

{% block title %}Personale Universitario{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/personale.css') }}">
{% endblock %}


{% block content %}
<div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th>Cognome</th>
        <th>Nome</th>
        <th>Email</th>
      </tr>
    </thead>
    <tbody>
      {% for persona in personale_list %}
      <tr data-email="{{ persona.email }}">
        <td>{{ persona.cognome }}</td>
        <td>{{ persona.nome }}</td>
        <td>{{ persona.email }}</td>
      </tr>
      {% else %}
      <tr>
        <td colspan="3" style="text-align: center; padding: 20px; color: #777;">
          Nessun personale trovato nel database.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div id="table-error-msg" class="table-error error-hidden">
  </div>


<div class="buttons">
  <button type="button" id="inserisci">Inserisci</button>
  <button type="button" id="modifica" disabled>Modifica</button>
  <button type="button" id="cancella" disabled>Cancella</button>
</div>
{% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {

    const table = document.querySelector('table tbody');
    const btnModifica = document.getElementById('modifica');
    const btnCancella = document.getElementById('cancella');
    const btnInserisci = document.getElementById('inserisci');
    const errorMsg = document.getElementById('table-error-msg');

    let selectedRow = null;
    let selectedEmail = null;

    function showErrorMessage(message) {
        errorMsg.textContent = message;
        errorMsg.classList.remove('error-hidden');
        errorMsg.classList.add('error-visible');
    }

    function hideErrorMessage() {
        errorMsg.classList.add('error-hidden');
        errorMsg.classList.remove('error-visible');
        errorMsg.textContent = '';
    }

    table.addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        if (!row || !row.dataset.email) return;

        hideErrorMessage();

        if (selectedRow) {
            selectedRow.classList.remove('selected');
        }

        if (selectedRow === row) {
            selectedRow = null;
            selectedEmail = null;
            btnModifica.disabled = true;
            btnCancella.disabled = true;
        } else {
            selectedRow = row;
            selectedRow.classList.add('selected');
            selectedEmail = row.dataset.email;
            btnModifica.disabled = false;
            btnCancella.disabled = false;
        }

        btnCancella.dataset.confirming = 'false';
        btnCancella.textContent = 'Cancella';
    });

    btnInserisci.addEventListener('click', () => {
        window.location.href = "{{ url_for('inserisci_personale') }}";
    });

    btnModifica.addEventListener('click', () => {
        if (!selectedEmail) {
            showErrorMessage('Nessuna riga selezionata. Clicca su una riga per modificarla.');
            return;
        }
        window.location.href = `/personale/modifica/${selectedEmail}`;
    });

    btnCancella.addEventListener('click', async () => {
        if (!selectedEmail) {
            showErrorMessage('Nessuna riga selezionata. Clicca su una riga per cancellarla.');
            return;
        }

        if (btnCancella.dataset.confirming !== 'true') {
            btnCancella.dataset.confirming = 'true';
            btnCancella.textContent = 'Confermi?';
            return;
        }

        try {
            const response = await fetch(`/personale/cancella/${selectedEmail}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (result.success) {
                selectedRow.remove();
                selectedRow = null;
                selectedEmail = null;
                btnModifica.disabled = true;
                btnCancella.disabled = true;
                hideErrorMessage();
            } else {
                showErrorMessage(result.error || 'Errore sconosciuto.');
            }

        } catch (error) {
            showErrorMessage('Errore di connessione con il server.');
        } finally {
            btnCancella.dataset.confirming = 'false';
            btnCancella.textContent = 'Cancella';
        }
    });

});
</script>
{% endblock %}