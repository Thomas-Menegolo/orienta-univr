{% extends "navbar.html" %}

{% block title %}Resoconto Attività{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/resoconto_attivita.css') }}">
{% endblock %}

{% block content %}
<div class="resoconto-container">

  <section class="resoconto-section">
    <div class="resoconto-header">
      <h1>{{ attivita.nome }}</h1>
      <a href="{{ url_for('attivita') }}" class="back-btn-resoconto">← Torna alle Attività</a>
    </div>
    <dl class="detail-grid">
      <dt>Periodo</dt>
      <dd>{{ attivita.data_inizio.strftime('%d/%m/%Y') }} - {{ attivita.data_fine.strftime('%d/%m/%Y') }}</dd>
      <dt>Ore Svolte</dt>
      <dd>{{ attivita.totale_ore or 'N/D' }}</dd>
      <dt>Descrizione</dt>
      <dd>{{ attivita.descrizione or 'Nessuna descrizione.' }}</dd>
      <dt>Dipartimento Organizzante</dt>
      <dd>{{ attivita.struttura_organizzante }}</dd>
      <dt>Docente Referente</dt>
      <dd>{{ attivita.docente_presidente_rel.cognome }} {{ attivita.docente_presidente_rel.nome }}</dd>
      <dt>Dipartimenti Partecipanti</dt>
      <dd>{{ collaboratori_str or 'Nessuno' }}</dd>
      <dt>Docenti Supervisori</dt>
      <dd>{{ supervisori_str or 'Nessuno' }}</dd>
    </dl>
  </section>

  <hr class="resoconto-divider">

  <section class="resoconto-section">
    <h2>Scuole Partecipanti</h2>
    {% if not part_map %}
      <p class="no-data">Nessuna scuola ha partecipato a questa attività.</p>
    {% endif %}

    {% for cm, data in part_map.items() %}
      <div class="scuola-card">
        <div class="scuola-card-header">
          <h3>{{ data.scuola_data.nome }}</h3>
          <span class="scuola-cm">{{ data.scuola_data.codice_meccanografico }}</span>
        </div>
        <dl class="detail-grid">
          <dt>Sede</dt>
          <dd>{{ data.scuola_data.via }} {{ data.scuola_data.numero_civico }}, {{ data.scuola_data.comune }}</dd>
          <dt>Dirigente</dt>
          <dd>{{ data.scuola_data.info_personali_dirigente.cognome }} {{ data.scuola_data.info_personali_dirigente.nome }} - {{ data.scuola_data.info_personali_dirigente.email }}</dd>
        </dl>

        <h4 class="indirizzi-title">Indirizzi</h4>
        <table class="indirizzi-table">
          <thead>
            <tr>
              <th>Indirizzo</th>
              <th>Referente</th>
              <th>Classi</th>
              <th>Tot. Studenti</th>
              <th>Maschi</th>
              <th>Femmine</th>
              <th>Altro</th>
            </tr>
          </thead>
          <tbody>
            {% for p in data.indirizzi %}
            <tr>
              <td>{{ p.indirizzo }}</td>
              <td>{{ p.indirizzi.info_personali_referente.cognome }} {{ p.indirizzi.info_personali_referente.nome }} - {{ p.indirizzi.info_personali_referente.email }}</td>
              <td>{{ p.classi or 'N/D' }}</td>
              <td>{{ p.totale_studenti or 'N/D' }}</td>
              <td>{{ p.totale_maschi or 'N/D' }}</td>
              <td>{{ p.totale_femmine or 'N/D' }}</td>
              <td>{{ (p.totale_studenti - (p.totale_maschi or 0) - (p.totale_femmine or 0)) if p.totale_studenti else 'N/D' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  </section>

  <hr class="resoconto-divider">

  <section class="resoconto-section">
    {% if not dati_disponibili %}
      <p class="no-data">Dati statistici non disponibili (Nessun studente registrato per questa attività).</p>
    {% else %}
      <div class="charts-container">
        <div class="chart-box">
          <h3 class="chart-title">Suddivisione studentesca per Scuola</h3>
          <div class="chart-wrapper">
            <canvas id="chartScuole"></canvas>
          </div>
          <div id="legendScuole" class="chart-legend-container"></div>
        </div>

        <div class="chart-box">
          <h3 class="chart-title">Suddivisione studentesca per Genere</h3>
          <div class="chart-wrapper">
            <canvas id="chartSesso"></canvas>
          </div>
          <div id="legendSesso" class="chart-legend-container"></div>
        </div>

        <div class="chart-box">
          <h3 class="chart-title">Suddivisione studentesca per Indirizzo</h3>
          <div class="chart-wrapper">
            <canvas id="chartIndirizzi"></canvas>
          </div>
          <div id="legendIndirizzi" class="chart-legend-container"></div>
        </div>
      </div>
    {% endif %}
  </section>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    if (!{{ dati_disponibili | tojson }}) return;

    const diverseColors = ['#4bc0c0', '#ffcd56', '#ff9f40', '#9966ff', '#c9cbcf', '#36a2eb', '#ff6384'];

    const getOrCreateLegendList = (chart, id) => {
      const legendContainer = document.getElementById(id);
      let listContainer = legendContainer.querySelector('ul');
      if (!listContainer) {
        listContainer = document.createElement('ul');
        listContainer.className = 'chart-legend-list';
        legendContainer.appendChild(listContainer);
      }
      return listContainer;
    };

    const htmlLegendPlugin = {
      id: 'htmlLegend',
      afterUpdate(chart, args, options) {
        const ul = getOrCreateLegendList(chart, options.containerID);
        ul.innerHTML = '';
        const items = chart.options.plugins.legend.labels.generateLabels(chart);
        items.forEach(item => {
          const li = document.createElement('li');
          li.className = 'chart-legend-item';
          li.onclick = () => { chart.toggleDataVisibility(item.index); chart.update(); };
          const colorBox = document.createElement('span');
          colorBox.className = 'legend-color-box';
          colorBox.style.backgroundColor = item.fillStyle;
          const textContainer = document.createElement('span');
          textContainer.className = 'legend-text';
          textContainer.style.textDecoration = item.hidden ? 'line-through' : '';
          textContainer.appendChild(document.createTextNode(item.text));
          li.appendChild(colorBox);
          li.appendChild(textContainer);
          ul.appendChild(li);
        });
      }
    };

    const tooltipLabelCallback = (context) => {
        let label = context.label || '';
        if (label) label += ': ';
        const value = context.raw || 0;
        const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
        label += `${value} (${percentage})`;
        return label;
    };

    const getChartOptions = (legendContainerID) => ({
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            htmlLegend: { containerID: legendContainerID },
            tooltip: { callbacks: { label: tooltipLabelCallback } }
        }
    });

    const ctxScuole = document.getElementById('chartScuole');
    new Chart(ctxScuole, {
        type: 'doughnut',
        data: {
            labels: {{ chart_scuole_labels | tojson }},
            datasets: [{
                label: 'Totale Studenti',
                data: {{ chart_scuole_data | tojson }},
                backgroundColor: diverseColors,
                borderWidth: 1
            }]
        },
        options: getChartOptions('legendScuole'),
        plugins: [htmlLegendPlugin]
    });

    const ctxSesso = document.getElementById('chartSesso');
    new Chart(ctxSesso, {
        type: 'doughnut',
        data: {
            labels: {{ chart_sesso_labels | tojson }},
            datasets: [{
                label: 'Suddivisione Sesso',
                data: {{ chart_sesso_data | tojson }},
                backgroundColor: ['rgb(54, 162, 235)', 'rgb(255, 99, 132)', 'rgb(201, 203, 207)'],
            }]
        },
        options: getChartOptions('legendSesso'),
        plugins: [htmlLegendPlugin]
    });

    const ctxIndirizzi = document.getElementById('chartIndirizzi');
    new Chart(ctxIndirizzi, {
        type: 'doughnut',
        data: {
            labels: {{ chart_indirizzi_labels | tojson }},
            datasets: [{
                label: 'Totale Studenti',
                data: {{ chart_indirizzi_data | tojson }},
                backgroundColor: diverseColors,
                borderWidth: 1
            }]
        },
        options: getChartOptions('legendIndirizzi'),
        plugins: [htmlLegendPlugin]
    });
});
</script>
{% endblock %}