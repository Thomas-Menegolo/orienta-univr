{% extends "navbar.html" %}

{% block title %}Scuole{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/scuola.css') }}">
{% endblock %}


{% block content %}
<div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th>Codice Meccanografico</th>
        <th>Nome</th>
        <th>Email</th>
        <th>Numero Telefonico</th>
        <th>Sede</th>
        <th>Dirigente</th>
      </tr>
    </thead>
    <tbody>
      {% for scuola in scuole_list %}
      <tr data-cm="{{ scuola.codice_meccanografico }}">
        <td>{{ scuola.codice_meccanografico }}</td>
        <td>{{ scuola.nome }}</td>
        <td>{{ scuola.email }}</td>
        <td>{{ scuola.numero_telefonico }}</td>
        <td>{{ scuola.via }} {{ scuola.numero_civico }}, {{ scuola.comune }}</td>
        <td>{{ scuola.info_personali_dirigente.nome }} {{ scuola.info_personali_dirigente.cognome }} - {{ scuola.info_personali_dirigente.email }}</td>
      </tr>
      {% else %}
      <tr>
        <td colspan="6" style="text-align: center; padding: 20px; color: #777;">
          Nessuna scuola trovata nel database.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div id="table-error-msg" class="table-error error-hidden">
  </div>


<div class="buttons">
  <button type="button" id="inserisci">Inserisci</button>
  <button type="button" id="modifica" disabled>Modifica</button>
  <button type="button" id="cancella" disabled>Cancella</button>
</div>
{% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {

    const table = document.querySelector('table tbody');
    const btnModifica = document.getElementById('modifica');
    const btnCancella = document.getElementById('cancella');
    const btnInserisci = document.getElementById('inserisci');
    const errorMsg = document.getElementById('table-error-msg');
    
    let selectedRow = null;
    let selectedCM = null;

    function showErrorMessage(message) {
        errorMsg.textContent = message;
        errorMsg.classList.remove('error-hidden');
        errorMsg.classList.add('error-visible');
    }

    function hideErrorMessage() {
        errorMsg.classList.add('error-hidden');
        errorMsg.classList.remove('error-visible');
        errorMsg.textContent = '';
    }

    table.addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        if (!row || !row.dataset.cm) return;

        hideErrorMessage(); 

        if (selectedRow) {
            selectedRow.classList.remove('selected');
        }

        if (selectedRow === row) {
            selectedRow = null;
            selectedCM = null;
            btnModifica.disabled = true;
            btnCancella.disabled = true;
        } else {
            selectedRow = row;
            selectedRow.classList.add('selected');
            selectedCM = row.dataset.cm;
            btnModifica.disabled = false;
            btnCancella.disabled = false;
        }
        
        btnCancella.dataset.confirming = 'false';
        btnCancella.textContent = 'Cancella';
    });

    btnInserisci.addEventListener('click', () => {
        window.location.href = "{{ url_for('inserisci_scuola') }}";
    });

    btnModifica.addEventListener('click', () => {
        if (!selectedCM) {
            showErrorMessage('Nessuna scuola selezionata. Clicca su una riga per modificarla.');
            return;
        }
        window.location.href = `/scuole/modifica/${selectedCM}`;
    });

    btnCancella.addEventListener('click', async () => {
        if (!selectedCM) {
            showErrorMessage('Nessuna scuola selezionata. Clicca su una riga per cancellarla.');
            return;
        }

        if (btnCancella.dataset.confirming !== 'true') {
            btnCancella.dataset.confirming = 'true';
            btnCancella.textContent = 'Confermi?';
            return;
        }

        try {
            const response = await fetch(`/scuole/cancella/${selectedCM}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (result.success) {
                selectedRow.remove();
                selectedRow = null;
                selectedCM = null;
                btnModifica.disabled = true;
                btnCancella.disabled = true;
                hideErrorMessage();
            } else {
                showErrorMessage(result.error || 'Errore sconosciuto.');
            }

        } catch (error) {
            showErrorMessage('Errore di connessione con il server.');
        } finally {
            btnCancella.dataset.confirming = 'false';
            btnCancella.textContent = 'Cancella';
        }
    });

});
</script>
{% endblock %}